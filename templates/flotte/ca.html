{% extends "base.html" %}
{% load humanize static %}
{% block title %}Chiffre d'affaires{% endblock %}
{% block page_title %}Chiffre d'affaires{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumb" aria-label="Fil d'Ariane"><a href="{% url 'flotte:dashboard' %}">Tableau de bord</a><span>›</span><span class="current">Chiffre d'affaires</span></nav>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ca-page.css' %}">
{% endblock %}

{% block content %}
<section class="ca-hero">
  <div class="ca-hero-inner">
    <div class="ca-hero-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    </div>
    <div class="ca-hero-text">
      <h2 class="ca-hero-title">Chiffre d'affaires</h2>
      <p class="ca-hero-desc">Synthèse des ventes, évolution par période et indicateurs clés. Les statistiques correspondent à l’ensemble des ventes enregistrées avec un montant (FCFA).</p>
    </div>
    <div class="ca-mask-toggle" id="ca-mask-toggle" role="button" tabindex="0" aria-pressed="false" title="Masquer / Afficher les montants">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
      <span id="ca-mask-label">Masquer les montants</span>
    </div>
  </div>
</section>

<h3 class="ca-section-title">Indicateurs clés</h3>
<div class="kpi-grid kpi-grid-ca">
  <div class="kpi-card kpi-card-primary">
    <span class="kpi-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    </span>
    <span class="kpi-label">CA total (FCFA)</span>
    <span class="kpi-value montant-fcfa" data-montant="{{ total_ca|floatformat:0 }}">{{ total_ca|floatformat:0 }}</span>
  </div>
  <div class="kpi-card">
    <span class="kpi-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    </span>
    <span class="kpi-label">Nombre de ventes</span>
    <span class="kpi-value">{{ nb_ventes }}</span>
  </div>
  <div class="kpi-card">
    <span class="kpi-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
    </span>
    <span class="kpi-label">Moyenne par vente (FCFA)</span>
    <span class="kpi-value montant-fcfa" data-montant="{{ moyenne_vente|floatformat:0 }}">{{ moyenne_vente|floatformat:0 }}</span>
  </div>
</div>

<h3 class="ca-section-title">Filtrer les graphiques</h3>
<div class="ca-filters-section">
  <div class="ca-filters">
    <label for="ca-granularite">Période</label>
    <select id="ca-granularite" class="select" aria-label="Granularité (jour, mois, année)">
      <option value="jour">Par jour</option>
      <option value="mois" selected>Par mois</option>
      <option value="annee">Par année</option>
    </select>
    <label for="ca-annee">Année</label>
    <select id="ca-annee" class="select" aria-label="Année">
      {% for y in annees %}
      <option value="{{ y }}" {% if y == annee_courante %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
    <span id="ca-mois-wrap" style="display: none;">
      <label for="ca-mois">Mois</label>
      <select id="ca-mois" class="select" aria-label="Mois">
        <option value="1" {% if mois_courant == 1 %}selected{% endif %}>Janvier</option>
        <option value="2" {% if mois_courant == 2 %}selected{% endif %}>Février</option>
        <option value="3" {% if mois_courant == 3 %}selected{% endif %}>Mars</option>
        <option value="4" {% if mois_courant == 4 %}selected{% endif %}>Avril</option>
        <option value="5" {% if mois_courant == 5 %}selected{% endif %}>Mai</option>
        <option value="6" {% if mois_courant == 6 %}selected{% endif %}>Juin</option>
        <option value="7" {% if mois_courant == 7 %}selected{% endif %}>Juillet</option>
        <option value="8" {% if mois_courant == 8 %}selected{% endif %}>Août</option>
        <option value="9" {% if mois_courant == 9 %}selected{% endif %}>Septembre</option>
        <option value="10" {% if mois_courant == 10 %}selected{% endif %}>Octobre</option>
        <option value="11" {% if mois_courant == 11 %}selected{% endif %}>Novembre</option>
        <option value="12" {% if mois_courant == 12 %}selected{% endif %}>Décembre</option>
      </select>
    </span>
    <button type="button" class="btn btn-primary btn-sm" id="ca-apply">Actualiser</button>
  </div>
</div>

<h3 class="ca-section-title">Évolution du CA</h3>
<div class="ca-charts-section">
<div class="ca-charts-grid">
  <div class="ca-chart-wrap" id="ca-chart-wrap-ca">
    <div class="ca-chart-loading" aria-live="polite"><span>Chargement…</span></div>
    <div class="ca-chart-empty" aria-live="polite"><p>Aucune donnée pour cette période.<br><span class="ca-chart-empty-hint">Choisissez une autre année puis Actualiser.</span></p></div>
    <div class="ca-chart-error" aria-live="polite"><p>Impossible de charger les données.<br>Vérifiez vos droits ou réessayez.</p></div>
    <h3>Évolution du chiffre d'affaires (FCFA)</h3>
    <div class="ca-chart-container">
      <canvas id="ca-chart" aria-label="Graphique évolution du CA"></canvas>
    </div>
  </div>
  <div class="ca-chart-wrap" id="ca-chart-wrap-ventes">
    <div class="ca-chart-loading" aria-live="polite"><span>Chargement…</span></div>
    <div class="ca-chart-empty" aria-live="polite"><p>Aucune donnée pour cette période.<br><span class="ca-chart-empty-hint">Choisissez une autre année puis Actualiser.</span></p></div>
    <div class="ca-chart-error" aria-live="polite"><p>Impossible de charger les données.<br>Vérifiez vos droits ou réessayez.</p></div>
    <h3>Nombre de ventes par période</h3>
    <div class="ca-chart-container">
      <canvas id="ca-chart-ventes" aria-label="Graphique nombre de ventes"></canvas>
    </div>
  </div>
</div>
</div>

<div class="card card-ca-summary">
  <div class="card-ca-summary-header">
    <span class="card-ca-summary-icon" aria-hidden="true">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
    </span>
    <div>
      <h2 class="card-title">Gestion financière</h2>
      <p class="card-desc">Factures, dépenses par véhicule (entretien, réparation, carburant, assurance) et montant total des ventes.</p>
    </div>
  </div>
  {% if is_manager_or_admin %}
  <div class="card-ca-actions">
    <a href="{% url 'flotte:ventes_list' %}" class="btn btn-primary">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
      Voir les ventes
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
(function() {
  var STORAGE_KEY = 'flotte_mask_amounts';
  var apiUrl = '{% url "flotte:ca_api_evolution" %}';

  function getMask() { try { return localStorage.getItem(STORAGE_KEY) === '1'; } catch (e) { return false; } }
  function setMask(on) { try { localStorage.setItem(STORAGE_KEY, on ? '1' : '0'); } catch (e) {} }

  function applyMaskToPage() {
    var on = getMask();
    document.body.classList.toggle('montants-masques', on);
    var label = document.getElementById('ca-mask-label');
    var btn = document.getElementById('ca-mask-toggle');
    if (label) label.textContent = on ? 'Afficher les montants' : 'Masquer les montants';
    if (btn) { btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', on ? 'true' : 'false'); }
    document.querySelectorAll('.montant-fcfa[data-montant]').forEach(function(el) {
      el.textContent = on ? '\u2014' : (el.getAttribute('data-montant') || el.textContent);
    });
  }

  var maskToggle = document.getElementById('ca-mask-toggle');
  if (maskToggle) {
    maskToggle.addEventListener('click', function() { setMask(!getMask()); applyMaskToPage(); });
    maskToggle.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); maskToggle.click(); } });
  }
  applyMaskToPage();

  var granularite = document.getElementById('ca-granularite');
  var annee = document.getElementById('ca-annee');
  var moisWrap = document.getElementById('ca-mois-wrap');
  var moisSelect = document.getElementById('ca-mois');
  function toggleMois() { moisWrap.style.display = granularite && granularite.value === 'jour' ? 'inline-flex' : 'none'; }
  if (granularite) { granularite.addEventListener('change', toggleMois); toggleMois(); }

  var anneeSelect = document.getElementById('ca-annee');
  if (!anneeSelect || !anneeSelect.options.length) {
    var y = new Date().getFullYear();
    for (var i = y - 4; i <= y + 1; i++) {
      var opt = document.createElement('option');
      opt.value = i; opt.textContent = i;
      if (i === y) opt.selected = true;
      anneeSelect.appendChild(opt);
    }
  }

  var chartCa = null;
  var chartVentes = null;
  var wrapCa = document.getElementById('ca-chart-wrap-ca');
  var wrapVentes = document.getElementById('ca-chart-wrap-ventes');

  function setLoading(loading) {
    if (wrapCa) wrapCa.classList.toggle('is-loading', !!loading);
    if (wrapVentes) wrapVentes.classList.toggle('is-loading', !!loading);
  }

  function setChartState(state) {
    if (wrapCa) { wrapCa.classList.remove('has-no-data', 'has-error'); if (state === 'no-data') wrapCa.classList.add('has-no-data'); if (state === 'error') wrapCa.classList.add('has-error'); }
    if (wrapVentes) { wrapVentes.classList.remove('has-no-data', 'has-error'); if (state === 'no-data') wrapVentes.classList.add('has-no-data'); if (state === 'error') wrapVentes.classList.add('has-error'); }
  }

  function buildChartCa(labels, data) {
    var ctx = document.getElementById('ca-chart');
    if (!ctx) return;
    if (chartCa) chartCa.destroy();
    chartCa = null;
    if (!labels.length) return;
    var dataNum = data.map(function(v) { return Number(v) || 0; });
    var h = ctx.parentElement ? ctx.parentElement.clientHeight || 280 : 280;
    var ctx2d = ctx.getContext('2d');
    var gradient = ctx2d.createLinearGradient(0, 0, 0, h);
    gradient.addColorStop(0, 'rgba(125, 107, 82, 0.55)');
    gradient.addColorStop(0.6, 'rgba(125, 107, 82, 0.25)');
    gradient.addColorStop(1, 'rgba(125, 107, 82, 0.08)');
    chartCa = new Chart(ctx2d, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'CA (FCFA)',
          data: dataNum,
          backgroundColor: gradient,
          borderColor: 'rgba(139, 118, 89, 0.9)',
          borderWidth: 1,
          borderRadius: 6,
          borderSkipped: false,
          barPercentage: 0.65,
          categoryPercentage: 0.8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 600 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(40, 40, 40, 0.95)',
            padding: 12,
            titleFont: { size: 13 },
            bodyFont: { size: 12 },
            callbacks: {
              label: function(item) {
                var v = item.raw;
                if (v >= 1e9) return (v / 1e9).toFixed(1) + ' Md FCFA';
                if (v >= 1e6) return (v / 1e6).toFixed(1) + ' M FCFA';
                if (v >= 1e3) return (v / 1e3).toFixed(0) + ' k FCFA';
                return v + ' FCFA';
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxRotation: 45, font: { size: 11 }, maxTicksLimit: 12 },
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: {
              font: { size: 11 },
              callback: function(v) {
                if (v >= 1e9) return (v / 1e9) + ' Md';
                if (v >= 1e6) return (v / 1e6) + ' M';
                if (v >= 1e3) return (v / 1e3) + ' k';
                return v;
              }
            }
          }
        }
      }
    });
  }

  function buildChartVentes(labels, nbVentes) {
    var ctx = document.getElementById('ca-chart-ventes');
    if (!ctx) return;
    if (chartVentes) chartVentes.destroy();
    chartVentes = null;
    if (!labels.length) return;
    var dataNum = nbVentes.map(function(v) { return Number(v) || 0; });
    var onePoint = dataNum.length === 1;
    chartVentes = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Nombre de ventes',
          data: dataNum,
          borderColor: 'rgb(72, 140, 115)',
          backgroundColor: 'rgba(72, 140, 115, 0.15)',
          borderWidth: 2,
          fill: true,
          tension: 0.35,
          spanGaps: true,
          pointRadius: onePoint ? 8 : 5,
          pointHoverRadius: onePoint ? 10 : 7,
          pointBackgroundColor: 'rgb(72, 140, 115)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 600 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(40, 40, 40, 0.95)',
            padding: 12,
            titleFont: { size: 13 },
            bodyFont: { size: 12 },
            callbacks: {
              label: function(item) {
                var v = item.raw;
                return (v === 1 ? '1 vente' : v + ' ventes');
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxRotation: 45, font: { size: 11 }, maxTicksLimit: 12 },
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: {
              stepSize: 1,
              font: { size: 11 },
              precision: 0,
            },
            min: 0,
          }
        }
      }
    });
  }

  function loadEvolution() {
    var g = (granularite && granularite.value) || 'mois';
    var a = (annee && annee.value) || new Date().getFullYear();
    var m = (granularite && granularite.value === 'jour' && moisSelect) ? moisSelect.value : '';
    var url = apiUrl + '?granularite=' + encodeURIComponent(g) + '&annee=' + encodeURIComponent(a);
    if (m) url += '&mois=' + encodeURIComponent(m);
    setLoading(true);
    setChartState('');
    fetch(url, {
      credentials: 'same-origin',
      headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(function(r) {
        if (!r.ok) { setChartState('error'); return null; }
        return r.json();
      })
      .then(function(json) {
        setLoading(false);
        if (!json) return;
        var labels = Array.isArray(json.labels) ? json.labels : [];
        var data = (json.data || []).map(function(v) { return Number(v) || 0; });
        var nbVentes = (json.nb_ventes || []).map(function(v) { return Number(v) || 0; });
        if (labels.length === 0) {
          if (chartCa) { chartCa.destroy(); chartCa = null; }
          if (chartVentes) { chartVentes.destroy(); chartVentes = null; }
          setChartState('no-data');
        } else {
          if (data.length !== labels.length) data = labels.map(function(_, i) { return data[i] !== undefined ? Number(data[i]) : 0; });
          if (nbVentes.length !== labels.length) nbVentes = labels.map(function(_, i) { return nbVentes[i] !== undefined ? Number(nbVentes[i]) : 0; });
          setChartState('normal');
          buildChartCa(labels, data);
          buildChartVentes(labels, nbVentes);
        }
      })
      .catch(function() {
        setLoading(false);
        setChartState('error');
        if (chartCa) { chartCa.destroy(); chartCa = null; }
        if (chartVentes) { chartVentes.destroy(); chartVentes = null; }
      });
  }

  document.getElementById('ca-apply').addEventListener('click', loadEvolution);
  if (granularite) granularite.addEventListener('change', function() { toggleMois(); loadEvolution(); });
  if (annee) annee.addEventListener('change', loadEvolution);
  if (moisSelect) moisSelect.addEventListener('change', loadEvolution);
  loadEvolution();
})();
</script>
{% endblock %}
