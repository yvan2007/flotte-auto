{% extends "base.html" %}
{% load humanize %}
{% block title %}Fiche location{% endblock %}
{% block page_title %}Fiche location — {{ location.vehicule.libelle_court }}{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumb" aria-label="Fil d'Ariane"><a href="{% url 'flotte:dashboard' %}">Tableau de bord</a><span>›</span><a href="{% url 'flotte:location_list' %}">Location</a><span>›</span><a href="{% url 'flotte:vehicule_detail' location.vehicule.pk %}">{{ location.vehicule.libelle_court }}</a><span>›</span><span class="current">Contrat</span></nav>
{% endblock %}
{% block content %}
<div class="fiche-grid">
  <div class="card fiche-block">
    <h3>Contrat</h3>
    <p><strong>Véhicule:</strong> <a href="{% url 'flotte:vehicule_detail' location.vehicule.pk %}">{{ location.vehicule.libelle_court }}</a> (châssis {{ location.vehicule.numero_chassis }})</p>
    <p><strong>Conducteur assigné:</strong> {% if location.conducteur %}{{ location.conducteur.nom }} {{ location.conducteur.prenom }} <a href="{% url 'flotte:conducteur_update' location.conducteur.pk %}" class="btn btn-ghost btn-sm">Fiche conducteur</a>{% else %}—{% endif %}</p>
    <p><strong>Locataire:</strong> {{ location.locataire }}</p>
    <p><strong>Type:</strong> {{ location.type_location }}</p>
    <p><strong>Début:</strong> {{ location.date_debut }}</p>
    <p><strong>Fin:</strong> {{ location.date_fin }}</p>
    <p><strong>Statut:</strong> {{ location.get_statut_display }}</p>
  </div>
  <div class="card fiche-block">
    <h3>Finances</h3>
    <p><strong>Loyer mensuel:</strong> {% if location.loyer_mensuel %}{{ location.loyer_mensuel|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Coût de location:</strong> {% if location.cout_location %}{{ location.cout_location|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Frais annexes (assurance, entretien, carburant…):</strong> {% if location.frais_annexes %}{{ location.frais_annexes|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Km inclus / mois:</strong> {{ location.km_inclus_mois|default:"—" }}</p>
    <p><strong>Prix km supplémentaire:</strong> {% if location.prix_km_supplementaire %}{{ location.prix_km_supplementaire }} FCFA/km{% else %}—{% endif %}</p>
    <p class="total-line"><strong>Coût total facture de location (loyer + frais + contraventions à la charge du locataire):</strong> {{ location.cout_total_location|floatformat:0 }} FCFA</p>
  </div>
  <div class="card fiche-block">
    <h3>Contraventions / amendes</h3>
    <p class="contravention-notice"><strong>Règle :</strong> Toute contravention reçue pendant la période de location est à la charge du locataire. Le montant est automatiquement ajouté à la facture de location (coût total ci-dessus), avec mention du motif, de la date et du véhicule concerné.</p>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:contravention_create' location.pk %}" class="btn btn-primary btn-sm">Ajouter une contravention</a></p>{% endif %}
    {% if location.contraventions.all %}
    <ul class="activity-list">
      {% for c in location.contraventions.all %}
      <li>
        <strong>Véhicule :</strong> {{ location.vehicule.libelle_court }} ({{ location.vehicule.numero_chassis }}) —
        {% if c.date_contravention %}{{ c.date_contravention }}{% endif %}
        {% if c.motif %}<strong>Motif :</strong> {{ c.motif }}{% endif %}
        {% if c.reference %} — N° PV {{ c.reference }}{% endif %}
        {% if c.lieu %} — Lieu : {{ c.lieu }}{% endif %}
        {% if c.montant %} — <strong>{{ c.montant|floatformat:0 }} FCFA</strong> (à la charge du locataire){% else %}—{% endif %}
        {% if is_manager_or_admin %}<a href="{% url 'flotte:contravention_update' c.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}
      </li>
      {% endfor %}
    </ul>
    <p><strong>Total contraventions (intégré à la facture de location) :</strong> {{ location.contraventions.all|length }} contravention(s) — {{ total_contraventions|floatformat:0 }} FCFA à la charge du locataire.</p>
    {% else %}
    <p>Aucune contravention enregistrée.</p>
    {% endif %}
  </div>
  <div class="card fiche-block">
    <h3>Échéances</h3>
    <p><strong>Expiration visite technique (CT):</strong> {{ location.date_expiration_ct|default:"—" }}</p>
    <p><strong>Expiration assurance:</strong> {{ location.date_expiration_assurance|default:"—" }}</p>
    <p><strong>Kilométrage prochaine vidange:</strong> {% if location.km_prochaine_vidange %}{{ location.km_prochaine_vidange|intcomma }} km{% else %}—{% endif %}</p>
  </div>
  {% if location.remarques %}
  <div class="card fiche-block">
    <h3>Remarques</h3>
    <p>{{ location.remarques }}</p>
  </div>
  {% endif %}
</div>
<p>
  <a href="{% url 'flotte:location_list' %}" class="btn btn-ghost">Retour à la liste</a>
  {% if is_manager_or_admin %}<a href="{% url 'flotte:location_update' location.pk %}" class="btn btn-primary">Modifier</a>{% endif %}
</p>
{% endblock %}
