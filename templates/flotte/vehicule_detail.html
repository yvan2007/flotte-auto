{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Fiche véhicule{% endblock %}
{% block page_title %}Fiche véhicule — {{ vehicule.numero_chassis }}{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumb" aria-label="Fil d'Ariane"><a href="{% url 'flotte:dashboard' %}">Tableau de bord</a><span>›</span><a href="{% url 'flotte:parc' %}">Parc / Flotte</a><span>›</span><span class="current">{{ vehicule.libelle_court }} ({{ vehicule.numero_chassis }})</span></nav>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vehicule-gallery.css' %}">
{% endblock %}
{% block content %}
<div class="fiche-grid">
  {% if photos %}
  <div class="card fiche-block vehicule-gallery-section">
    <div class="gallery-header">
      <h3>Photos du véhicule</h3>
      {% if is_manager_or_admin %}
      <a href="{% url 'flotte:photo_vehicule_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une photo</a>
      {% endif %}
    </div>
    <div class="photo-gallery">
      {% for photo in photos %}
      <div class="photo-item {% if photo.est_principale %}photo-principale{% endif %}" data-photo-id="{{ photo.pk }}">
        <div class="photo-wrapper">
          <img src="{{ photo.photo.url }}" alt="{{ photo.get_angle_display }}{% if photo.description %} — {{ photo.description }}{% endif %}" class="photo-thumbnail" loading="lazy">
          {% if photo.est_principale %}
          <span class="badge badge-primary photo-badge">Principale</span>
          {% endif %}
          <div class="photo-overlay">
            <div class="photo-info">
              <span class="photo-angle">{{ photo.get_angle_display }}</span>
              {% if photo.description %}
              <span class="photo-description">{{ photo.description }}</span>
              {% endif %}
            </div>
            <div class="photo-actions">
              <button class="btn-icon btn-view" onclick="openLightbox('{{ photo.photo.url }}', '{{ photo.get_angle_display }}{% if photo.description %} — {{ photo.description }}{% endif %}')" title="Voir en grand">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              {% if is_manager_or_admin %}
              <a href="{% url 'flotte:photo_vehicule_update' photo.pk %}" class="btn-icon btn-edit" title="Modifier">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </a>
              <a href="{% url 'flotte:photo_vehicule_delete' photo.pk %}" class="btn-icon btn-delete" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette photo ?');">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="card fiche-block vehicule-gallery-section">
    <div class="gallery-header">
      <h3>Photos du véhicule</h3>
      {% if is_manager_or_admin %}
      <a href="{% url 'flotte:photo_vehicule_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une photo</a>
      {% endif %}
    </div>
    <p class="no-photos">Aucune photo disponible. {% if is_manager_or_admin %}Ajoutez des photos pour documenter le véhicule sous tous les angles.{% endif %}</p>
  </div>
  {% endif %}

  <div class="card fiche-block">
    <h3>Identification</h3>
    <p><strong>Châssis:</strong> {{ vehicule.numero_chassis }}</p>
    <p><strong>Marque / Modèle:</strong> {{ vehicule.marque.nom|default:"—" }} {{ vehicule.modele.nom|default:"" }}</p>
    <p><strong>Type:</strong> {{ vehicule.type_vehicule.libelle|default:"—" }}</p>
    <p><strong>Année:</strong> {{ vehicule.annee|default:"—" }}</p>
    <p><strong>Carburant:</strong> {{ vehicule.type_carburant.libelle|default:"—" }}</p>
    <p><strong>Transmission:</strong> {{ vehicule.type_transmission.libelle|default:"—" }}</p>
    <p><strong>Couleur ext.:</strong> {{ vehicule.couleur_exterieure|default:"—" }}</p>
    <p><strong>Couleur int.:</strong> {{ vehicule.couleur_interieure|default:"—" }}</p>
    <p><strong>N° immat.:</strong> {{ vehicule.numero_immatriculation|default:"—" }}</p>
    <p><strong>Km actuel:</strong> {{ vehicule.kilometrage_actuel|intcomma }}</p>
    <p><strong>Statut:</strong> {{ vehicule.get_statut_display }}</p>
    <p><strong>Date entrée parc:</strong> {{ vehicule.date_entree_parc|default:"—" }}</p>
    <p><strong>Prix d'achat:</strong> {% if vehicule.prix_achat %}{{ vehicule.prix_achat|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Pays d'origine (ou d'achat):</strong> {{ vehicule.origine_pays|default:"—" }}</p>
    <p><strong>Km prochaine vidange:</strong> {% if vehicule.km_prochaine_vidange %}{{ vehicule.km_prochaine_vidange|intcomma }} km{% else %}—{% endif %}</p>
    {% if is_manager_or_admin %}
    <p><a href="{% url 'flotte:vehicule_update' vehicule.pk %}" class="btn btn-primary btn-sm">Modifier</a></p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Démarches import</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:import_demarche_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une démarche</a></p>{% endif %}
    {% if vehicule.import_demarches.all %}
    <ul class="activity-list">
      {% for d in vehicule.import_demarches.all %}
      <li><span class="badge badge-ok">{{ d.etape }}</span> {{ d.date_etape|default:"" }} {{ d.statut_etape|default:"" }}{% if d.remarque %} — {{ d.remarque|truncatewords:10 }}{% endif %}{% if d.fichier %} <a href="{{ d.fichier.url }}" class="link-doc" target="_blank" rel="noopener">Document</a>{% endif %} {% if is_manager_or_admin %}<a href="{% url 'flotte:import_demarche_update' d.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucune démarche enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Charges d'importation</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:charge_import_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter des charges</a></p>{% endif %}
    {% if vehicule.charges_import.all %}
    <ul class="activity-list">
      {% for c in vehicule.charges_import.all %}
      <li>Fret {% if c.fret %}{{ c.fret|floatformat:0 }} FCFA{% else %}—{% endif %} · Dédouanement {% if c.frais_dedouanement %}{{ c.frais_dedouanement|floatformat:0 }}{% else %}—{% endif %} · Transitaire {% if c.frais_transitaire %}{{ c.frais_transitaire|floatformat:0 }}{% else %}—{% endif %} → <strong>Total {% if c.cout_total %}{{ c.cout_total|floatformat:0 }} FCFA{% else %}—{% endif %}</strong> {% if is_manager_or_admin %}<a href="{% url 'flotte:charge_import_update' c.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    <p class="total-line">Total charges d'import : <strong>{{ total_charges_import|floatformat:0 }} FCFA</strong></p>
    {% else %}
    <p>Aucune charge d'importation enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Pièces / parties importées</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:partie_importee_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une pièce</a></p>{% endif %}
    {% if vehicule.parties_importees.all %}
    <ul class="activity-list">
      {% for p in vehicule.parties_importees.all %}
      <li>{{ p.designation }} — Qté {{ p.quantite }}{% if p.cout_unitaire %} × {{ p.cout_unitaire|floatformat:0 }} FCFA{% endif %}{% if p.cout_total %} = {{ p.cout_total|floatformat:0 }} FCFA{% endif %} {% if is_manager_or_admin %}<a href="{% url 'flotte:partie_importee_update' p.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucune pièce importée liée à ce véhicule.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Dépenses (coûts véhicule)</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:depense_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une dépense</a></p>{% endif %}
    {% if vehicule.depenses.all %}
    <ul class="activity-list">
      {% for dep in vehicule.depenses.all %}
      <li><span class="badge badge-muted">{{ dep.get_type_depense_display }}</span> {{ dep.libelle }}{% if dep.phase %} — {{ dep.phase }}{% endif %} : {% if dep.montant %}{{ dep.montant|floatformat:0 }} FCFA{% endif %}{% if dep.date_depense %} ({{ dep.date_depense }}){% endif %} {% if is_manager_or_admin %}<a href="{% url 'flotte:depense_update' dep.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    <p><strong>Total dépenses:</strong> {{ total_depenses|floatformat:0 }} FCFA</p>
    {% else %}
    <p>Aucune dépense enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Documents</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:document_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter un document</a></p>{% endif %}
    {% if vehicule.documents.all %}
    <ul class="activity-list">
      {% for doc in vehicule.documents.all %}
      <li>{% if doc.disponible %}<span class="badge badge-ok">Disponible</span>{% else %}<span class="badge badge-warn">À faire</span>{% endif %} {{ doc.libelle_type }}{% if doc.numero %} ({{ doc.numero }}){% endif %}{% if doc.date_echeance %} — Échéance {{ doc.date_echeance }}{% endif %}{% if doc.fichier %} <a href="{{ doc.fichier.url }}" class="link-doc" target="_blank" rel="noopener">Fichier</a>{% endif %} {% if is_manager_or_admin %}<a href="{% url 'flotte:document_update' doc.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucun document enregistré.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Réparations</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:reparation_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une réparation</a></p>{% endif %}
    {% if vehicule.reparations.all %}
    <ul class="activity-list">
      {% for r in vehicule.reparations.all %}
      <li>{{ r.date_reparation|default:"" }} — {{ r.type_rep|default:"" }} : {{ r.description|truncatewords:12 }}{% if r.cout %} — {{ r.cout|floatformat:0 }} FCFA{% endif %}{% if r.a_faire %} <span class="badge badge-warn">À faire</span>{% endif %} {% if is_manager_or_admin %}<a href="{% url 'flotte:reparation_update' r.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    <p><strong>Total réparations:</strong> {{ total_reparations|floatformat:0 }} FCFA</p>
    {% else %}
    <p>Aucune réparation enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Ventes</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:vente_create' vehicule.pk %}" class="btn btn-primary btn-sm">Enregistrer une vente</a></p>{% endif %}
    {% if vehicule.ventes.all %}
    <ul class="activity-list">
      {% for v in vehicule.ventes.all %}
      <li>{{ v.date_vente }}{% if v.acquereur %} — {{ v.acquereur }}{% endif %}{% if v.prix_vente %} : {{ v.prix_vente|floatformat:0 }} FCFA{% endif %}{% if is_manager_or_admin %} <a href="{% url 'flotte:vente_update' v.pk %}" class="btn btn-ghost btn-sm">Modifier</a>{% endif %}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucune vente enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Locations</h3>
    {% if vehicule.locations.all %}
    <ul class="activity-list">
      {% for loc in vehicule.locations.all %}
      <li><a href="{% url 'flotte:location_detail' loc.pk %}">{{ loc.locataire }}</a> — {{ loc.type_location }} ({{ loc.date_debut }} → {{ loc.date_fin }}) — {{ loc.get_statut_display }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucune location.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Factures</h3>
    {% if is_manager_or_admin %}<p><a href="{% url 'flotte:facture_create' vehicule.pk %}" class="btn btn-primary btn-sm">Ajouter une facture</a></p>{% endif %}
    {% if vehicule.factures.all %}
    <ul class="activity-list">
      {% for f in vehicule.factures.all %}
      <li>
        <strong>{{ f.numero }}</strong>{% if f.fournisseur %} — {{ f.fournisseur }}{% endif %}{% if f.date_facture %} ({{ f.date_facture }}){% endif %} : {% if f.montant %}{{ f.montant|floatformat:0 }} FCFA{% endif %}{% if f.type_facture %} — {{ f.type_facture }}{% endif %}{% if f.fichier %} <a href="{{ f.fichier.url }}" class="link-doc" target="_blank" rel="noopener">PDF</a>{% endif %}
        {% if f.penalites.all %}
        <ul style="margin:0.5rem 0 0 1.5rem; list-style:disc;">
          {% for p in f.penalites.all %}
          <li>Pénalité : {{ p.libelle }}{% if p.date_penalite %} ({{ p.date_penalite }}){% endif %}{% if p.montant %} — {{ p.montant|floatformat:0 }} FCFA{% endif %}
          {% if is_manager_or_admin %}<a href="{% url 'flotte:penalite_facture_update' p.pk %}" class="btn btn-ghost btn-sm">Modifier</a> <a href="{% url 'flotte:penalite_facture_delete' p.pk %}" class="btn btn-ghost btn-sm" onclick="return confirm('Supprimer cette pénalité ?');">Supprimer</a>{% endif %}</li>
          {% endfor %}
        </ul>
        <p style="margin:0.25rem 0 0 1.5rem;"><strong>Total avec pénalités : {{ f.total_avec_penalites|floatformat:0 }} FCFA</strong></p>
        {% endif %}
        {% if is_manager_or_admin %}
        <p style="margin-top:0.5rem;">
          <a href="{% url 'flotte:facture_update' f.pk %}" class="btn btn-ghost btn-sm">Modifier la facture</a>
          <a href="{% url 'flotte:penalite_facture_create' f.pk %}" class="btn btn-ghost btn-sm">Ajouter une pénalité</a>
        </p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>Aucune facture enregistrée.</p>
    {% endif %}
  </div>

  <div class="card fiche-block">
    <h3>Coûts & marge</h3>
    <p><strong>Prix d'achat:</strong> {% if vehicule.prix_achat %}{{ vehicule.prix_achat|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Total charges import:</strong> {{ total_charges_import|floatformat:0 }} FCFA</p>
    <p><strong>Total dépenses:</strong> {{ total_depenses|floatformat:0 }} FCFA</p>
    <p><strong>Total réparations:</strong> {{ total_reparations|floatformat:0 }} FCFA</p>
    <p class="total-line"><strong>Coût total (réf. facturation):</strong> {{ cout_total|floatformat:0 }} FCFA</p>
    {% if derniere_vente %}
    <p><strong>Dernière vente:</strong> {{ derniere_vente.prix_vente|floatformat:0 }} FCFA ({{ derniere_vente.date_vente }}) — {{ derniere_vente.acquereur|default:"" }}</p>
    {% if marge is not None %}
    <p><strong>Marge:</strong> {{ marge|floatformat:0 }} FCFA</p>
    {% endif %}
    {% endif %}
  </div>

  {% if vehicule.statut == 'vendu' and derniere_vente %}
  <div class="card fiche-block">
    <h3>Vente / Cession</h3>
    <p><strong>Date:</strong> {{ derniere_vente.date_vente }}</p>
    <p><strong>Acquéreur:</strong> {{ derniere_vente.acquereur|default:"—" }}</p>
    <p><strong>Prix vente:</strong> {% if derniere_vente.prix_vente %}{{ derniere_vente.prix_vente|floatformat:0 }} FCFA{% else %}—{% endif %}</p>
    <p><strong>Km à la vente:</strong> {{ derniere_vente.km_vente|default:"—"|intcomma }}</p>
    <p><strong>Garantie:</strong> {{ derniere_vente.garantie_duree|default:"—" }}</p>
    <p><strong>État livraison:</strong> {{ derniere_vente.etat_livraison|default:"—" }}</p>
  </div>
  {% endif %}
</div>

<!-- Lightbox pour afficher les photos en grand -->
<div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
  <div class="lightbox-content" onclick="event.stopPropagation()">
    <button class="lightbox-close" onclick="closeLightbox()" aria-label="Fermer">&times;</button>
    <img id="lightbox-image" src="" alt="">
    <div id="lightbox-caption"></div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function openLightbox(imageSrc, caption) {
  var lightbox = document.getElementById('lightbox');
  var lightboxImage = document.getElementById('lightbox-image');
  var lightboxCaption = document.getElementById('lightbox-caption');
  lightboxImage.src = imageSrc;
  lightboxCaption.textContent = caption || '';
  lightbox.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeLightbox(event) {
  if (!event || event.target.id === 'lightbox' || event.target.classList.contains('lightbox-close')) {
    var lightbox = document.getElementById('lightbox');
    lightbox.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Fermer avec la touche Échap
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeLightbox({target: {id: 'lightbox'}});
  }
});
</script>
{% endblock %}
